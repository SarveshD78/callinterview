<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Talexa Interview System</title>
    <script src="{{ url_for('static', filename='js/bundle.js') }}"></script>

</head>
<body>
    <h1>Talexa Interview System</h1>

    <!-- Call form -->
    <input type="text" id="candidateNumber" placeholder="Enter candidate number">
    <button id="callButton">Call Candidate</button>

    <!-- Debug logs -->
    <pre id="logArea" style="background:#f0f0f0; padding:10px; max-height:300px; overflow:auto;"></pre>

    <script>
    let device;

    function log(msg) {
        console.log(msg);
        document.getElementById('logArea').textContent += msg + "\n";
    }

    async function getToken() {
        log("Fetching Twilio token...");
        const response = await fetch('/token');
        const data = await response.json();
        log("Token received");
        return data.token;
    }

    async function initTwilio() {
        const token = await getToken();

        log("Initializing Twilio.Device...");
        device = new Twilio.Device(token, {
            debug: true
        });

        device.on('ready', () => log("Twilio Device Ready"));
        device.on('error', (error) => log("Twilio Device Error: " + error.message));

        // Automatically accept incoming calls
        device.on('incoming', (connection) => {
            log("Incoming call from: " + connection.parameters.From);
            connection.accept();
            log("Call accepted automatically!");
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initTwilio();

        document.getElementById('callButton').addEventListener('click', async () => {
            const toNumber = document.getElementById('candidateNumber').value;
            if (!toNumber) return alert('Enter candidate number');

            try {
                log("Starting call to: " + toNumber);
                const response = await fetch('/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ to: toNumber })
                });
                const data = await response.json();
                log('Call response: ' + JSON.stringify(data));
            } catch (err) {
                log('Error starting call: ' + err);
            }
        });
    });
    </script>
</body>
</html>
