<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talexa Interview System</title>
    <script src="https://media.twiliocdn.com/sdk/js/client/v1.17/twilio.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px 20px; }
        select { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>Talexa Interview System</h1>

    <div>
        <label>Microphone: </label>
        <select id="input-devices"></select>
    </div>
    <div>
        <label>Speakers: </label>
        <select id="output-devices"></select>
    </div>

    <div>
        <button id="start-device">Initialize Device</button>
        <button id="call-button">Call Candidate</button>
        <button id="answer-button">Answer Incoming Call</button>
        <button id="hangup-button">Hang Up</button>
    </div>

    <script>
        let device;
        let currentConnection;

        const inputSelect = document.getElementById('input-devices');
        const outputSelect = document.getElementById('output-devices');

        async function fetchToken() {
            const res = await fetch('/token');
            const data = await res.json();
            return data.token;
        }

        async function populateDevices() {
            const devices = await Twilio.Device.audio.availableInputDevices();
            inputSelect.innerHTML = '';
            devices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || d.deviceId;
                inputSelect.appendChild(opt);
            });

            const outputs = await Twilio.Device.audio.availableOutputDevices();
            outputSelect.innerHTML = '';
            outputs.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || d.deviceId;
                outputSelect.appendChild(opt);
            });
        }

        document.getElementById('start-device').onclick = async () => {
            // Must be triggered by user gesture
            const token = await fetchToken();
            device = new Twilio.Device(token, { debug: true });

            device.on('ready', () => console.log('Twilio Device Ready'));
            device.on('error', err => console.error('Device error:', err));
            device.on('incoming', conn => {
                console.log('Incoming call from:', conn.parameters.From);
                currentConnection = conn;
            });
            device.on('connect', conn => currentConnection = conn);
            device.on('disconnect', conn => currentConnection = null);

            await populateDevices();

            // Set initial audio devices
            const selectedInput = inputSelect.value;
            if (selectedInput) device.audio.inputDevices.set(selectedInput);
            const selectedOutput = outputSelect.value;
            if (selectedOutput) device.audio.outputDevices.set(selectedOutput);

            // Listen for changes
            inputSelect.onchange = () => device.audio.inputDevices.set(inputSelect.value);
            outputSelect.onchange = () => device.audio.outputDevices.set(outputSelect.value);

            console.log('Device initialized');
        };

        document.getElementById('call-button').onclick = () => {
            const toNumber = prompt('Enter candidate number (with country code, e.g., +91xxxx):');
            if (!toNumber) return alert('Number required');

            currentConnection = device.connect({ To: toNumber });
            console.log('Calling:', toNumber);
        };

        document.getElementById('answer-button').onclick = () => {
            if (currentConnection) {
                currentConnection.accept();
                console.log('Call answered');
            } else {
                alert('No incoming call');
            }
        };

        document.getElementById('hangup-button').onclick = () => {
            if (currentConnection) {
                currentConnection.disconnect();
                console.log('Call hung up');
            } else {
                alert('No active call');
            }
        };
    </script>
</body>
</html>
