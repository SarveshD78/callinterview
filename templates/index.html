<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Twilio Browser Call</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #logs { background: #f7f7f7; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: auto; }
        button { margin: 5px; }
    </style>
</head>
<body>
    <h1>üìû Twilio Browser Call</h1>

    <label>Phone Number:</label>
    <input type="text" id="phoneNumber" placeholder="+91XXXXXXXXXX">
    <br>
    <button onclick="makeCall()">Call</button>
    <button onclick="hangUp()">Hang Up</button>

    <h2>Logs</h2>
    <div id="logs"></div>

    <!-- Load Twilio SDK from static -->
    <script src="{{ url_for('static', filename='js/twilio.min.js') }}"></script>

    <script>
        let device;

        function log(message) {
            const logs = document.getElementById("logs");
            logs.innerHTML += message + "<br>";
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        async function setupDevice() {
            log("Fetching Twilio token...");
            try {
                const res = await fetch("/token");
                const data = await res.json();

                if (!data.token) {
                    log("‚ùå Failed to fetch token");
                    return;
                }

                log("‚úÖ Got Twilio token");

                device = new Twilio.Device(data.token, {
                    logLevel: 1, // Debug logging
                    codecPreferences: ["opus", "pcmu"]
                });

                device.on("ready", () => log("üîî Device is ready"));
                device.on("error", (err) => log("‚ùå Error: " + err.message));
                device.on("connect", () => log("üîó Call connected"));
                device.on("disconnect", () => log("‚ùå Call disconnected"));
                device.on("incoming", (conn) => {
                    log("üì≤ Incoming call");
                    conn.accept();
                });

            } catch (e) {
                log("‚ùå Exception while setting up device: " + e);
            }
        }

        async function makeCall() {
            const number = document.getElementById("phoneNumber").value;
            if (!number) {
                log("‚ö†Ô∏è Enter a phone number first");
                return;
            }

            if (!device) {
                log("‚ö†Ô∏è Device not ready yet");
                return;
            }

            log("üìû Calling " + number + "...");
            const conn = device.connect({ params: { To: number } });
        }

        function hangUp() {
            if (device) {
                log("üì¥ Hanging up...");
                device.disconnectAll();
            }
        }

        // Initialize on page load
        setupDevice();
    </script>
</body>
</html>
